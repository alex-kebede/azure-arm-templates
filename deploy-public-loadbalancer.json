{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
	"loadBalancerName": {
	    "type": "string",
	    "metadata": {
		"description": "Name of the loadbalancer"
	    }
	},
	"virtualNetworkName": {
	    "type": "string",
	    "metadata": {
		"description": "Name of the virtual network"
	    }
	},
	"subNetName": {
	    "type": "string",
	    "metadata": {
		"description": "Name of the sub net"
	    }
	},
	"nicName": {
	    "type": "string",
	    "metadata": {
		"description": "Name of the nic to attach to"
	    }
	},
	"backEndPort": {
	    "type": "int",
	    "metadata": {
		"description": "the port to connect to"
	    }
	},
	"backEndSSLPort": {
	    "type": "int",
	    "metadata": {
		"description": "the port to connect to for SSL"
	    }
	}
    },
    "variables": {
	"vnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
	"subnetRef": "[concat(variables('vnetID'),'/subnets/', parameters('subnetName'))]",
	"publicIPAddressType": "Static",
	"backEndName":"backEnd",
	"backEndSSLName":"backEndSSL",
	"frontEndName":"frontEnd",
	"probeName":"probe",
	"publicIPAddressID": "[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]",
	"publicIPAddressName":"[concat(parameters('loadBalancerName'), '-public-ip')]",
	"apiVersion": "2015-06-15"
    },
    "resources": [
	{
	    "apiVersion": "[variables('apiVersion')]",
	    "type": "Microsoft.Network/publicIPAddresses",
	    "name": "[variables('publicIPAddressName')]",
	    "location": "[resourceGroup().location]",
	    "properties": {
		"publicIPAllocationMethod": "[variables('publicIPAddressType')]"
	    }
	},
	{
	    "apiVersion": "[variables('apiVersion')]",
	    "name": "[parameters('loadBalancerName')]",
	    "type": "Microsoft.Network/loadBalancers",
	    "location": "[resourceGroup().location]",
	    "dependsOn": [
		"[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
	    ],
	    "properties": {
		"frontendIPConfigurations": [
		    {
			"name": "[variables('frontEndName')]",
			"properties": {
			    "publicIPAddress":{
				"id":"[variables('publicIPAddressID')]"
			    }
			}
		    }
		],
		"backendAddressPools": [
		    {
			"name": "[variables('backEndName')]"
		    },
		    {
			"name": "[variables('backEndSSLName')]"
		    }
		],
		"loadBalancingRules": [
		    {
			"properties": {
			    "frontendIPConfiguration": {
				"id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/frontendIpConfigurations/',variables('frontEndName'))]"
			    },
			    "backendAddressPool": {
				"id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/backendAddressPools/', variables('backEndName'))]"
			    },
			    "probe": {
				"id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/probes/', variables('probeName'))]"
			    },
			    "protocol": "Tcp",
			    "frontendPort": 80,
			    "backendPort": "[parameters('backEndPort')]",
			    "idleTimeoutInMinutes": 15
			},
			"name": "http"
		    },
		    {
			"properties": {
			    "frontendIPConfiguration": {
				"id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/frontendIpConfigurations/',variables('frontEndName'))]"
			    },
			    "backendAddressPool": {
				"id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/backendAddressPools/', variables('backEndSSLName'))]"
			    },
			    "probe": {
				"id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/probes/', variables('probeName'))]"
			    },
			    "protocol": "Tcp",
			    "frontendPort": 443,
			    "backendPort": "[parameters('backEndSSLPort')]",
			    "idleTimeoutInMinutes": 15
			},
			"name": "https"
		    }
		],
		"probes": [
		    {
			"properties": {
			    "protocol": "Tcp",
			    "port": "[parameters('backEndSSLPort')]",
			    "intervalInSeconds": 15,
			    "numberOfProbes": 2
			},
			"name": "[variables('probeName')]"
		    }
		]
	    }
	}
    ]
}
